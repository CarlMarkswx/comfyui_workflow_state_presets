# ComfyUI Workflow State Presets 开发文档

## 1. 背景与目标

### 1.1 背景痛点

- ComfyUI 自带控制组在应用界面使用受限。
- 控制组倾向于“按群组控制”，不适合跨组或全局节点状态切换。
- 现有常见切换节点存在输入口固定、切换数量上限（如 10）等问题。

### 1.2 核心目标

在**同一工作流**内实现“套装切换”：

1. 记录所有节点的 mode/bypass 状态为套装。
2. 使用一个 `int` 索引在多套方案间快速切换。
3. 取消固定输入口数量限制（支持任意数量 preset）。
4. 后续扩展到参数快照与连线切换。

---

## 2. 范围与规划

### 当前范围（可发布）

- 记录与应用节点 mode/bypass 状态。
- 支持通过 `Preset Switch` 节点输入 `preset_index: INT` 触发切换。
- 支持多个 preset（动态存储，不限制为 10）。
- `Preset Switch` 提供以下交互：
  - `Add Preset`（新增并切换到下一个可用 index）
  - `Record Current`（记录当前 index）
  - `Delete Selected`（删除当前 index）
  - `Prev Preset` / `Next Preset`（循环切换）
  - 内嵌 `Preset Browser` 列表（点击切换）
  - `Rename Current` 字符串输入框（重命名当前 index）
  - 支持从上游链接输入自动解析 `preset_index`（包含 Reroute 链）
- `Preset Group Editor` 提供分组三态控制（启用/绕过/停用），并支持过滤、排序、导航与启用限制。
- `Preset Group Editor` 支持批量按钮（全部启用/全部绕过/全部停用）与分组标题双击重命名。

### 后续开发目标

- 扩展节点 Widget 参数快照能力（如步数、CFG、Sampler 等）。
- 增加参数白名单/黑名单机制，支持更细粒度控制。
- 扩展节点连线切换能力，并补充冲突处理与安全策略。

---

## 3. 技术架构

采用“**前端主控 + 后端桥接**”架构：

1. **前端（web/preset_switch.js）**
   - 读取当前画布节点状态。
   - 记录 preset。
   - 应用 preset。
   - 响应 switch 节点 index 变化。
   - 维护 preset 列表面板、重命名、删除、循环切换等交互。
   - 当输入口被连接时，沿链路解析上游数值作为 `preset_index`。

2. **前端（web/preset_group_editor.js）**
   - 为 Group 提供三态可视化行控件（启用/绕过/停用）。
   - 支持颜色/标题过滤、排序、自定义字母序、跨子图扫描、导航定位。
   - 支持启用限制策略（`default/max one/always one`）。
   - 支持双击分组名重命名与批量状态按钮。

3. **后端（nodes.py）**
   - 定义 `Preset Switch` 节点。
   - 定义 `Preset Group Editor` 节点。
   - 提供 `preset_index` 输入，作为流程中的显式切换控制入口。

4. **持久化策略**
   - 当前优先存到 workflow metadata（随工作流保存）。
   - 后续可扩展全局 preset 库（跨 workflow 复用）。

---

## 4. 数据结构设计

```json
{
  "version": 1,
  "presets": {
    "0": {
      "name": "Preset 0",
      "nodes": {
        "12": { "mode": 0, "bypass": false },
        "13": { "mode": 4, "bypass": true }
      },
      "updated_at": 1700000000000
    },
    "1": {
      "name": "Preset 1",
      "nodes": {
        "12": { "mode": 2, "bypass": true },
        "13": { "mode": 0, "bypass": false }
      },
      "updated_at": 1700000000000
    }
  },
  "options": {
    "onMissingNode": "skip",
    "indexOutOfRange": "warn"
  }
}
```

扩展字段预留：

- `nodes[id].widgets`（用于参数快照）
- `links`（用于连线切换）

---

## 5. 交互流程

1. 用户调整当前工作流节点 mode/bypass 状态。
2. 将 switch 节点的 `preset_index` 设为目标值（如 0）。
3. 点击“Record Current”记录为该 index 套装。
4. 重复步骤 1~3 保存更多方案。
5. 可通过 `Prev/Next` 或 `Preset Browser` 快速切换。
6. 运行时仅通过 index 变化触发套装切换（含上游输入链接驱动）。

---

## 6. 模块与文件职责

```text
comfyui_workflow_state_presets/
├─ __init__.py                    # 节点映射导出
├─ nodes.py                       # Preset Switch / Preset Group Editor 节点
├─ web/
│  ├─ preset_switch.js            # 前端核心逻辑（记录/应用/监听）
│  ├─ preset_group_editor.js      # 分组三态管理
│  └─ style.css                   # 样式（可选）
├─ docs/
│  ├─ 开发文档.md
│  └─ reference/
└─ README.md
```

---

## 7. 边界与风险处理

1. **缺失节点**：preset 内节点在当前图不存在 → 跳过并告警。
2. **索引越界**：没有对应 preset → 告警并保持当前状态。
3. **版本兼容**：ComfyUI 前端 API 可能变化 → 统一封装访问接口。
4. **批量刷新性能**：应用时使用批量写入 + 统一刷新。
5. **UI 兼容输出**：`Preset Group Editor` 保留兼容输出 `OPT_CONNECTION`，默认隐藏避免干扰界面。
6. **输入链接优先级**：当 `preset_index` 输入被连接时，以链路解析值为准；未连接时使用节点 widget 值。

---

## 8. 里程碑

- M1：插件骨架搭建（目录 + 节点 + 前端入口）
- M2：记录/应用 mode+bypass preset
- M3：index 自动触发切换
- M4：预设浏览、删除、重命名、上游 index 解析与分组编辑器完善
- M5：参数快照与连线切换能力扩展
