# ComfyUI Workflow State Presets 开发文档

## 1. 背景与目标

### 1.1 背景痛点

- ComfyUI 自带控制组在应用界面使用受限。
- 控制组倾向于“按群组控制”，不适合跨组或全局节点状态切换。
- 现有常见切换节点存在输入口固定、切换数量上限（如 10）等问题。

### 1.2 核心目标

在**同一工作流**内实现“套装切换”：

1. 记录所有节点的激活/忽略（bypass）状态为套装。
2. 使用一个 `int` 索引在多套方案间快速切换。
3. 取消固定输入口数量限制（支持任意数量 preset）。
4. 后续扩展到参数快照与连线切换。

---

## 2. 范围与规划

### 当前范围（可发布）

- 记录与应用节点 bypass/mode 状态。
- 支持通过 `Preset Switch` 节点输入 `preset_index: INT` 触发切换。
- 支持多个 preset（动态存储，不限制为 10）。

### 后续开发目标

- 扩展节点 Widget 参数快照能力（如步数、CFG、Sampler 等）。
- 增加参数白名单/黑名单机制，支持更细粒度控制。
- 扩展节点连线切换能力，并补充冲突处理与安全策略。

---

## 3. 技术架构

采用“**前端主控 + 后端桥接**”架构：

1. **前端（web/preset_switch.js）**
   - 读取当前画布节点状态。
   - 记录 preset。
   - 应用 preset。
   - 响应 switch 节点 index 变化。

2. **后端（nodes.py）**
   - 定义 `Preset Switch` 节点。
   - 提供 `preset_index` 输入，作为流程中的显式切换控制入口。

3. **持久化策略**
   - 当前优先存到 workflow metadata（随工作流保存）。
   - 后续可扩展全局 preset 库（跨 workflow 复用）。

---

## 4. 数据结构设计

```json
{
  "version": 1,
  "presets": {
    "0": {
      "name": "Preset 0",
      "nodes": {
        "12": { "bypass": false },
        "13": { "bypass": true }
      }
    },
    "1": {
      "name": "Preset 1",
      "nodes": {
        "12": { "bypass": true },
        "13": { "bypass": false }
      }
    }
  },
  "options": {
    "onMissingNode": "skip",
    "indexOutOfRange": "warn"
  }
}
```

扩展字段预留：

- `nodes[id].widgets`（用于参数快照）
- `links`（用于连线切换）

---

## 5. 交互流程

1. 用户调整当前工作流节点 bypass 状态。
2. 将 switch 节点的 `preset_index` 设为目标值（如 0）。
3. 点击“Record Current”记录为该 index 套装。
4. 重复步骤 1~3 保存更多方案。
5. 运行时仅通过 index 变化触发套装切换。

---

## 6. 模块与文件职责

```text
comfyui_workflow_state_presets/
├─ __init__.py                    # 节点映射导出
├─ nodes.py                       # Preset Switch / Preset Group Editor 节点
├─ web/
│  ├─ preset_switch.js            # 前端核心逻辑（记录/应用/监听）
│  ├─ preset_group_editor.js      # 分组三态管理
│  └─ style.css                   # 样式（可选）
├─ docs/
│  ├─ 开发文档.md
│  └─ 需求简述.ini
└─ README.md
```

---

## 7. 边界与风险处理

1. **缺失节点**：preset 内节点在当前图不存在 → 跳过并告警。
2. **索引越界**：没有对应 preset → 告警并保持当前状态。
3. **版本兼容**：ComfyUI 前端 API 可能变化 → 统一封装访问接口。
4. **批量刷新性能**：应用时使用批量写入 + 统一刷新。

---

## 8. 里程碑

- M1：插件骨架搭建（目录 + 节点 + 前端入口）
- M2：记录/应用 bypass preset
- M3：index 自动触发切换
- M4：异常处理与文档完善
- M5：参数快照与连线切换能力扩展
